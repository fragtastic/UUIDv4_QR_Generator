<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UUIDv4 QR Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Generates QR code images with a random UUIDv4 in different qualities.">
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <script rel="preload" as="script" src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <style>
    :root {
      --bg-light: #f5f5f5;
      --bg-dark: #020617;

      --text-light: #111827;
      --text-dark: #e5e7eb;

      --card-light: #ffffff;
      --card-dark: #0f172a;

      --primary: #3a6fc4;

      --quality-bg-light: #4b5563;
      --quality-bg-dark: #1e293b;

      --quality-active: var(--primary);
    }

    body {
      margin: 0;
      padding: 2rem 1rem;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
      min-height: 100vh;
      transition: background 0.2s, color 0.2s;
    }

    /* Light mode */
    body.light {
      background: var(--bg-light);
      color: var(--text-light);
    }

    body.light #uuid,
    body.light #qrcode {
      background: var(--card-light);
    }

    body.light .btn-quality {
      background: var(--quality-bg-light);
      color: white;
    }

    /* Dark mode */
    body.dark {
      background: var(--bg-dark);
      color: var(--text-dark);
    }

    body.dark #uuid,
    body.dark #qrcode {
      background: var(--card-dark);
    }

    body.dark .btn-quality {
      background: var(--quality-bg-dark);
      color: white;
    }

    /* Shared button styles */
    .btn {
      padding: 0.6rem 1.2rem;
      border: none;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.9rem;
      background: var(--primary);
      color: white;
      transition: filter 0.1s, transform 0.1s;
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-1px);
    }

    .quality-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn-quality.active {
      background: var(--quality-active) !important;
    }

    #uuid {
      font-family: monospace;
      padding: 0.6rem 1rem;
      border-radius: 0.5rem;
      word-break: break-all;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      max-width: 32rem;
    }

    #qrcode {
      padding: 0.75rem;
      border-radius: 0.5rem;
      box-shadow: 0 1px 4px rgba(0,0,0,0.25);
      /* set size ahead of time to prevent layout shift */
      width: 256px;
      height: 256px;
    }

    /* Put toggle button at bottom center */
    #themeToggle {
      margin-top: 0.5rem;
      background: #64748b;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>

  <h1>UUIDv4 QR Generator</h1>

  <div id="uuid">Loading…</div>

  <div class="quality-buttons">
    <button class="btn btn-quality active" data-q="L">L</button>
    <button class="btn btn-quality" data-q="M">M</button>
    <button class="btn btn-quality" data-q="Q">Q</button>
    <button class="btn btn-quality" data-q="H">H</button>
  </div>

  <div id="qrcode"></div>

  <button id="newUUID" class="btn">Generate New UUID</button>

  <!-- ▼ THEME TOGGLE NOW LIVES HERE ▼ -->
  <button id="themeToggle" class="btn">Toggle Theme</button>

  <script>
    /* ----------------------- DARK MODE HANDLING ----------------------- */

    const saved = localStorage.getItem("theme");

    function applyTheme(mode) {
      document.body.classList.remove("dark", "light");
      document.body.classList.add(mode);
    }

    // Default = dark mode unless user has chosen otherwise
    if (saved) {
      applyTheme(saved);
    } else {
      applyTheme("dark");
    }

    document.getElementById("themeToggle").addEventListener("click", () => {
      const newMode = document.body.classList.contains("dark") ? "light" : "dark";
      applyTheme(newMode);
      localStorage.setItem("theme", newMode);
    });

    /* ----------------------- QR + UUID LOGIC ----------------------- */

    function uuidv4() {
      if (crypto.randomUUID) return crypto.randomUUID();

      const bytes = new Uint8Array(16);
      crypto.getRandomValues(bytes);
      bytes[6] = (bytes[6] & 0x0f) | 0x40;
      bytes[8] = (bytes[8] & 0x3f) | 0x80;

      return [...bytes].map((b, i) =>
        (i === 4 || i === 6 || i === 8 || i === 10 ? "-" : "") +
        b.toString(16).padStart(2, "0")
      ).join("");
    }

    const uuidDiv = document.getElementById("uuid");
    const qrDiv = document.getElementById("qrcode");
    const newBtn = document.getElementById("newUUID");
    const qualityButtons = document.querySelectorAll("[data-q]");

    let currentQuality = "L";
    let currentUUID = "";
    let qr = null;

    function createQRCodeInstance() {
      qrDiv.innerHTML = "";
      qr = new QRCode(qrDiv, {
        width: 256,
        height: 256,
        correctLevel: QRCode.CorrectLevel[currentQuality]
      });
    }

    function setQRCodeAltText() {
      const img = qrDiv.querySelector("img");
      if (img) {
        img.alt = `Image of UUIDv4 QR code with value ${currentUUID}`;
      }
    }

    function renderQR() {
      if (!qr) createQRCodeInstance();
      qr.clear();
      qr.makeCode(currentUUID);
      setQRCodeAltText();
    }

    function generateNewUUID() {
      currentUUID = uuidv4();
      uuidDiv.textContent = currentUUID;
      renderQR();
    }

    qualityButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        currentQuality = btn.dataset.q;

        qualityButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        createQRCodeInstance();
        renderQR();
      });
    });

    newBtn.addEventListener("click", generateNewUUID);

    // Initial load
    function runInitialQR() {
      createQRCodeInstance();
      generateNewUUID();
    }

    // Let the page render first, then do QR work when the main thread is idle-ish
    if ("requestIdleCallback" in window) {
      requestIdleCallback(runInitialQR);
    } else {
      // Fallback for browsers without requestIdleCallback
      window.addEventListener("load", () => {
        setTimeout(runInitialQR, 0);
      });
    }
  </script>

</body>
</html>
